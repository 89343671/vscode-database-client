<html>

<head>
    <title>result</title>
    <link rel="stylesheet" href="${webviewPath}/css/element.css">
    <script src="${webviewPath}/js/vue.js"></script>
    <script src="${webviewPath}/js/element.js"></script>
    <style>
        body {
            background-color: #F7F7F7;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
        }

        .hint {
            padding: 5px;
            font-size: 17px;
            color: #444;
            display: inline-block;
            margin-top: 8px;
        }

        .cell {
            overflow: hidden !important;
            text-overflow: unset !important;
            white-space: nowrap !important;
            user-select: text !important;
        }
        .info-panel{
            color: #444;
            font-size: 16px;
            background-color: white;
            border:1px solid #dcdfe6;
            border-radius: 5px;
            padding: 10px;
            margin-left:6px;
        }

        /*定义滚动条样式（高宽及背景）*/
        ::-webkit-scrollbar {
            /* 滚动条宽度， width：对应竖滚动条的宽度  height：对应横滚动条的高度*/
            /* width: 6px;   
            background: #007acc; */
        }

        /*定义滚动条轨道（凹槽）样式*/
        ::-webkit-scrollbar-track {
            /* 较少使用 */
            /* -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);   
            border-radius: 3px;  */
        }

        /*定义滑块 样式*/
        ::-webkit-scrollbar-thumb {
            /* 滚动条滑块长度 */
            /* border-radius: 3px; 
            height: 100px;   
            background-color: #ccc;  */
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="hint">
            <el-row style="margin-bottom: 10px;">
                <el-input type="textarea" autosize v-model="toolbar.sql" style="width: 600px;"></el-input>
            </el-row>
            <el-row>
                <el-cow>
                    <el-button type="info" icon="el-icon-circle-plus-outline" size="mini" circle @click="insertRequest"
                        v-if="result.table">
                    </el-button>
                </el-cow>
                <el-cow>
                    <el-input v-model="table.search" style="width:200px" placeholder="Type to search" />
                </el-cow>
                <el-cow>
                    <el-button type="primary" @click='execute(toolbar.sql);info.visible = false;'>Execute</el-button>
                </el-cow>
                <el-cow>
                    <span>costTime: </span><span v-text="toolbar.costTime"></span>ms
                    <span v-if="result.table">,row: {{result.data.length}}, Col: {{columnCount}}</span>
                </el-cow>
            </el-row>
        </div>
        <div v-if="info.visible">
            <div class="info-panel" v-html="info.message"></div>
        </div>
        <div :style="'width:' + table.width + 'px;overflow:scroll'" v-if="result.table">
            <el-table id="dataTable" v-loading='table.loading' size='small'
                :data="result.data.filter(data => !table.search || JSON.stringify(data).toLowerCase().includes(table.search.toLowerCase()))"
                border @cell-click="celledit">
                <!-- tool bar -->
                <el-table-column fixed="left" label="Operations" width="100" v-if="result.primaryKey">
                    <template slot-scope="scope">
                        <el-button @click="openEdit(scope.row)" type="text" size="small">Edit</el-button>
                        <el-button @click="deleteConfirm(scope.row[result.primaryKey])" type="text" size="small">Delete
                        </el-button>
                    </template>
                </el-table-column>
                <!-- table view -->
                <el-table-column :label="column" v-for="(column) in result.columnList" :key="column" align="center"
                    v-if="result.columnList" :width="computeWidth(column)">
                    <template slot-scope="scope">
                        <span v-html='dataformat(scope.row[column])'></span>
                    </template>
                </el-table-column>
                <!-- sql view -->
                <el-table-column :label="key" v-for="(value,key) in result.data[0]" :key="key" align="center"
                    v-if="!result.columnList" :width="computeWidth(key)">
                    <template slot-scope="scope">
                        <span v-html='dataformat(scope.row[key])'></span>
                    </template>
                </el-table-column>

            </el-table>
        </div>
        <el-dialog :title="editorTilte" :visible.sync="editor.visible" width="70%" :before-close="handleClose">
            <el-form label-width="120px">
                <el-form-item :label="column" :key="column" v-for="column in result.columnList">
                    <el-input v-model="update.currentNew[column]"></el-input>
                </el-form-item>
            </el-form>
            <span slot="footer" class="dialog-footer">
                <el-button @click="editor.visible = false">Cancel</el-button>
                <el-button v-if="update.primary!=null" type="primary" :loading="editor.loading" @click="confirmUpdate">
                    Update</el-button>
                <el-button v-if="update.primary==null" type="primary" :loading="editor.loading" @click="confirmInsert">
                    Insert</el-button>
            </span>
        </el-dialog>
    </div>
</body>

<script>
    const vscode = acquireVsCodeApi();
    // const previousState = vscode.getState();
    const previousState = false;
    const vue = new Vue({
        el: '#app',
        data: {
            result: {
                data: [],
                sql: '',
                primaryKey: null,
                columnList: null,
                database: null,
                table: null
            },
            table: {
                search: '',
                loading: true,
                width: null,
                widthItem: {}
            },
            toolbar: {
                sql: null,
                costTime: 0,
                isRefrsh: false
            },
            editor: {
                visible: false,
                loading: false
            },
            info: {
                sql: null,
                message: null,
                visible: false
            },
            update: {
                current: {},
                currentNew: {},
                primary: null
            }
        },
        methods: {
            insertRequest() {
                this.editor.visible = true;
                this.update.primary = null;
                this.update.currentNew = {};
            },
            confirmInsert() {
                let columns = "";
                let values = "";
                for (const key in this.update.currentNew) {
                    const newEle = this.update.currentNew[key];
                    if (newEle) {
                        columns += `${key},`;
                        values += `'${newEle}',`;
                    }
                }
                if (values) {
                    const insertSql = `INSERT INTO ${this.result.table}(${columns.replace(/,$/, "")}) VALUES(${values.replace(/,$/, "")})`
                    this.execute(insertSql)
                } else {
                    this.$message("Not any input, update fail!")
                }
            },
            confirmUpdate() {
                let change = "";
                for (const key in this.update.currentNew) {
                    const oldEle = this.update.current[key];
                    const newEle = this.update.currentNew[key];
                    if (oldEle != newEle) {
                        change += `${key}='${newEle}',`
                    }
                }
                if (change) {
                    const updateSql = `UPDATE ${this.result.table} SET ${change.replace(/,$/, "")} WHERE ${this.result.primaryKey}=${this.update.primary}`
                    this.execute(updateSql)
                } else {
                    this.$message("Not any change, update fail!")
                }
            },
            openEdit(row) {
                this.editor.visible = true;
                this.update = {
                    current: row,
                    currentNew: this.deepClone(row),
                    primary: row[this.result.primaryKey]
                }
            },
            deleteConfirm(primaryValue) {
                this.$confirm('Are you sure you want to delete this data?', 'Warning', {
                    confirmButtonText: 'OK',
                    cancelButtonText: 'Cancel',
                    type: 'warning'
                }).then(() => {
                    const deleteSql = `DELETE FROM ${this.result.table} WHERE ${this.result.primaryKey}='${primaryValue}'`;
                    this.execute(deleteSql)
                }).catch(() => {
                    this.$message({ type: 'info', message: 'Update canceled' });
                });
            },
            updateWidth() {
                let width = 0;
                for (const key in this.table.widthItem) {
                    width = width + parseInt(this.table.widthItem[key])
                }
                if (this.result.primaryKey) {
                    width += 60;
                }
                this.table.width = width + 60;

            },
            computeWidth(key, index) {
                if (this.table.widthItem[key]) return this.table.widthItem[key];
                if (!index) index = 0
                if (!this.result.data[index] || index > 10) return 60;
                var value = this.result.data[index][key];
                var dynamic = value ? ((value + "").length) * 10 : ((key + "").length) * 10;
                if (dynamic > 600) dynamic = 600;
                if (dynamic < 60) dynamic = 60;
                var nextDynamic = this.computeWidth(key, ++index)
                if (dynamic < nextDynamic) dynamic = nextDynamic;
                this.table.widthItem[key] = dynamic;
                this.updateWidth()
                return dynamic;
            },
            celledit(row, column, cell, event) {
                cell.contentEditable = true;
                if (this.result.primaryKey) {
                    this.update.primary = row[this.result.primaryKey]
                }
            },
            refresh() {
                if (this.result.sql) {
                    this.toolbar.isRefrsh = true;
                    this.execute(this.result.sql)
                }
            },
            execute(sql) {
                if (!sql) return;
                vscode.postMessage({
                    type: 'execute',
                    sql: sql
                });
                this.table.loading = true;
            },
            deleteTemplate() {
                this.result.sql = `DELETE FROM [table] WHERE id= `;
            },
            dataformat(origin) {
                if (origin == undefined || origin == null) {
                    return "<b>(NULL)</b>";
                }
                return origin;
            },
            deepClone(obj) {
                let objClone = Array.isArray(obj) ? [] : {};
                if (obj && typeof obj === "object") {
                    for (let key in obj) {
                        if (obj.hasOwnProperty(key)) {
                            if (obj[key] && typeof obj[key] === "object") {
                                objClone[key] = this.deepClone(obj[key]);
                            } else {
                                objClone[key] = obj[key];
                            }
                        }
                    }
                }
                return objClone;
            }
        },
        computed: {
            columnCount() {
                if (this.result.data == undefined || this.result.data[0] == undefined) return 0;
                return Object.keys(this.result.data[0]).length;
            },
            editorTilte() {
                if (this.update.primary == null) {
                    return 'Insert To ' + this.result.table
                }
                return 'Edit ' + this.result.table + ' : ' + this.result.primaryKey + '=' + this.update.primary
            },
        }
    })

    const handlerData = (data) => {
        
        vue.result.sql = data.sql;
        vue.toolbar.sql = data.sql;
        vue.table.widthItem = {}
        vue.result = data;
        vue.table.loading = false
        if (vue.toolbar.isRefrsh) {
            vue.toolbar.isRefrsh = false;
        } else {
            vue.info.visible = false;
        }
        // vscode.setState({ result: vue.result }); is instead by retainContextWhenHidden=true
    }

    const handlerDml = (res) => {
        // TODO 回显优化
        vue.editor.loading = false;
        vue.editor.visible = false;
        vue.info.visible = true;
        vue.info.message = res.message
        // vue.$message({ type: 'success', message: `EXECUTE ${res.sql} SUCCESS, affectedRows:${res.affectedRows}` });
        vue.refresh()
    }

    window.addEventListener('message', event => {
        vue.table.loading = false;
        let response = event.data.res;
        if (response.costTime) {
            vue.toolbar.costTime = response.costTime
        }
        
        switch (event.data.type) {
            case "RUN":
                vue.toolbar.sql = response.sql;
                vue.table.loading = true;
                break;
            case "DATA":
                handlerData(response)
                break;
            case "DML":
            case "ERROR":
                handlerDml(response)
                break;
            default:
                vue.$message(JSON.stringify(event.data));
        }
    });
    vscode.postMessage({ type: 'init' })
</script>

</html>