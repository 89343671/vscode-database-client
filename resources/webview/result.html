<html>

<head>
    <title>result</title>
    <link rel="stylesheet" href="${webviewPath}/css/element.css">
    <script src="${webviewPath}/js/vue.js"></script>
    <script src="${webviewPath}/js/element.js"></script>
    <style>
        body {
            background-color: #F7F7F7;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
        }

        .hint {
            padding: 5px;
            font-size: 17px;
            color: #444;
            display: inline-block;
            margin-top: 8px;
        }

        .cell {
            overflow: hidden !important;
            text-overflow: unset !important;
            white-space: nowrap !important;
            user-select: text !important;
        }

        /*定义滚动条样式（高宽及背景）*/
        ::-webkit-scrollbar {
            /* 滚动条宽度， width：对应竖滚动条的宽度  height：对应横滚动条的高度*/
            /* width: 6px;   
            background: #007acc; */
        }

        /*定义滚动条轨道（凹槽）样式*/
        ::-webkit-scrollbar-track {
            /* 较少使用 */
            /* -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);   
            border-radius: 3px;  */
        }

        /*定义滑块 样式*/
        ::-webkit-scrollbar-thumb {
            /* 滚动条滑块长度 */
            /* border-radius: 3px; 
            height: 100px;   
            background-color: #ccc;  */
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="hint">
            <el-row style="margin-bottom: 10px;">
                <el-input type="textarea" autosize v-model="activeSql" style="width: 600px;"></el-input>
            </el-row>
            <el-row>
                <el-cow>
                    <el-input v-model="search" style="width:200px" placeholder="Type to search" />
                </el-cow>
                <el-cow>
                    <el-button type="primary" @click='execute'>Execute</el-button>
                </el-cow>
                <el-cow>
                    <span>costTime: </span><span v-text="result.costTime"></span>ms,
                    <span>row: {{result.data.length}}, Col: {{columnCount}}</span>
                </el-cow>
            </el-row>
            <!-- <el-row style="margin-bottom: 10px;">
                <el-input type="textarea" readonly autosize :value="updateSql" v-if="update.where"
                    style="width: 600px;"></el-input>
            </el-row> -->
        </div>
        <div :style="'width:' + tableWidth + 'px;overflow:scroll'">
            <el-table id="dataTable" v-loading='loading' size='small'
                :data="result.data.filter(data => !search || JSON.stringify(data).toLowerCase().includes(search.toLowerCase()))"
                border @cell-click="celledit">
                <!-- tool bar -->
                <el-table-column fixed="left" label="Operations" width="120" v-if="result.primaryKey">
                    <template slot-scope="scope">
                        <el-button @click="openEdit(scope.row)"
                            type="text" size="small">Edit</el-button>
                        <el-button
                            @click="deleteConfirm(scope.row[result.primaryKey])" type="text" size="small">Delete
                        </el-button>
                    </template>
                </el-table-column>
                <!-- table view -->
                <el-table-column :label="column" v-for="(column) in result.columnList" :key="column" align="center"
                    v-if="result.columnList" :width="computeWidth(column)">
                    <template slot-scope="scope">
                        <span v-html='dataformat(scope.row[column])'></span>
                    </template>
                </el-table-column>
                <!-- sql view -->
                <el-table-column :label="key" v-for="(value,key) in result.data[0]" :key="key" align="center"
                    v-if="!result.columnList" :width="computeWidth(key)">
                    <template slot-scope="scope">
                        <span v-html='dataformat(scope.row[key])'></span>
                    </template>
                </el-table-column>

            </el-table>
        </div>
        <el-dialog title="Tips" :visible.sync="dialogVisible" width="30%" :before-close="handleClose">
            <span>This is a message</span>
            <span slot="footer" class="dialog-footer">
                <el-button @click="dialogVisible = false">Cancel</el-button>
                <el-button type="primary" @click="dialogVisible = false">Confirm</el-button>
            </span>
        </el-dialog>
    </div>
</body>

<script>
    const vscode = acquireVsCodeApi();
    // const previousState = vscode.getState();
    const previousState = false;
    const vue = new Vue({
        el: '#app',
        data: {
            result: previousState ? previousState.result : {
                data: [],
                sql: '',
                costTime: 0
            },
            tableWidth: null,
            widthCache: {},
            search: '',
            dialogVisible: false,
            loading: true,
            activeSql: null,
            optSql: null,
            update: {
                sql: null,
                where: 'w',
                primary: 'p'
            }

        },
        methods: {
            openEdit(row) {
                this.dialogVisible = true;
            },
            deleteConfirm(primaryValue) {
                this.$confirm('Are you sure you want to delete this data?', 'Warning', {
                    confirmButtonText: 'OK',
                    cancelButtonText: 'Cancel',
                    type: 'warning'
                }).then(() => {
                    this.optSql = `delete from ${this.result.table} where ${this.result.primaryKey}='${primaryValue}'`;
                    this.execute(this.optSql)
                }).catch(() => {
                    this.$message({ type: 'info', message: 'Delete canceled' });
                });
            },
            updateWidth() {
                let width = 0;
                for (const key in this.widthCache) {
                    width = width + parseInt(this.widthCache[key])
                }
                this.tableWidth = width + 60;
            },
            computeWidth(key, index) {

                if (this.widthCache[key]) return this.widthCache[key];
                if (!index) index = 0
                if (!this.result.data[index] || index > 10) return 60;
                var value = this.result.data[index][key];
                var dynamic = value ? ((value + "").length) * 10 : ((key + "").length) * 10;
                if (dynamic > 600) dynamic = 600;
                if (dynamic < 60) dynamic = 60;
                var nextDynamic = this.computeWidth(key, ++index)
                if (dynamic < nextDynamic) dynamic = nextDynamic;
                this.widthCache[key] = dynamic;
                this.updateWidth()
                return dynamic;
            },
            celledit(row, column, cell, event) {
                cell.contentEditable = true;
                // cell.focus()
                if (this.result.primaryKey) {
                    this.update.primary = row[this.result.primaryKey]
                    // this.update.sql=row[this.result.primaryKey]
                }
            },
            refresh(){
                if(this.result){
                    this.execute(this.result.sql)
                }
            },
            execute(sql) {
                if (!sql ) sql = this.activeSql
                vscode.postMessage({
                    type: 'execute',
                    sql: sql
                });
                this.loading = true;
            },
            deleteTemplate() {
                this.result.sql = `DELETE FROM [table] WHERE id= `;
            },
            dataformat(origin) {
                if (origin == undefined || origin == null) {
                    return "<b>(NULL)</b>";
                }
                return origin;
            }
        },
        computed: {
            columnCount() {
                if (this.result.data == undefined || this.result.data[0] == undefined) return 0;
                return Object.keys(this.result.data[0]).length;
            }, updateSql() {
                if (this.update.sql && this.update.where) {
                    return this.update.sql.replace('#1', this.update.where).replace('#2', this.update.primary)
                }
                return null;
            }
        }
    })

    const handlerData = (data) => {
        if (data.primaryKey && data.database && data.table) {
            vue.update.sql = `update \`${data.database}\`.\`${data.table}\`
set #1
where \`${data.primaryKey}\`='#2' `
        }
        if (data.sql) {
            vue.result.sql = data.sql;
            vue.activeSql = data.sql;
            vue.result.costTime = 0;
            vue.loading = true
        }
        if (data.costTime) {
            vue.result.costTime = data.costTime
        }
        if (data.data != null) {
            vue.widthCache = {}
            vue.result = data;
            vue.loading = false
        }

        // instead by retainContextWhenHidden=true
        // vscode.setState({ result: vue.result });
    }

    const optDone = () => {
        vue.$message({ type: 'success', message: `execute ${vue.optSql} success!` });
        vue.refresh()
    }

    window.addEventListener('message', event => {
        let type = event.data.type
        vue.loading = false;
        switch (event.data.type) {
            case "data":
                handlerData(event.data)
                break;
            case "opt":
                optDone()
                break;
            default:
            vue.$message({ type: 'success', message: JSON.stringify(event.data) });
        }
    });
    vscode.postMessage({ type: 'init' })
</script>

</html>