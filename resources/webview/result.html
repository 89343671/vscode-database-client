<html>

<head>
    <title>result</title>
    <link rel="stylesheet" href="${webviewPath}/css/element.css">
    <script src="${webviewPath}/js/vue.js"></script>
    <script src="${webviewPath}/js/element.js"></script>
    <style>
        body {
            background-color: #F7F7F7;
        }

        .hint {
            padding: 5px;
            font-size: 17px;
            color: #444;
            display: inline-block;
            margin-top: 8px;
        }

        .toolbar {
            margin: 5px;
        }

        .cell {
            overflow: hidden !important;
            text-overflow: unset !important;
            white-space: nowrap !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="hint">
            <el-input type="textarea" autosize v-model="result.sql" style="width: 600px;">
            </el-input>
            <div class="toolbar">
                <span>executeTime : </span><span v-text="updateTime"></span>
                <el-button type="danger" @click='execute' round>Execute</el-button>
                <el-button type="primary" round>ExportData</el-button>
            </div>
        </div>
        <el-table
            :data="result.rows.filter(data => !search || JSON.stringify(data).toLowerCase().includes(search.toLowerCase()))"
            style="width: 100%" border @cell-click="celledit">
            <el-table-column :label="key" v-for="(value,key) in result.rows[0]" :key="key" width="140" sortable
                show-overflow-tooltip="true" align="center">
                <template slot-scope="scope">
                    <span>{{scope.row[key]}}</span>
                </template>
            </el-table-column>
            <el-table-column fixed="right" label="Operations" width="120">
                <template slot="header" slot-scope="scope">
                    <el-input v-model="search" size="mini" placeholder="Type to search" />
                </template>
                <template slot-scope="scope">
                    <el-button @click="save" type="text" size="small">Save</el-button>
                    <el-button @click="deleteConfirm" type="text" size="small">Delete</el-button>
                </template>
            </el-table-column>
        </el-table>
    </div>
</body>

<script>
    var formatNow = function (formatStr) {
        var date = new Date();
        var zeroize = function (value, length) {
            if (!length) {
                length = 2;
            }
            value = new String(value);
            for (var i = 0, zeros = ''; i < (length - value.length); i++) {
                zeros += '0';
            }
            return zeros + value;
        };
        return formatStr.replace(/"[^"]*"|'[^']*'|\b(?:d{1,4}|M{1,4}|yy(?:yy)?|([hHmstT])\1?|[lLZ])\b/g, function ($0) {
            switch ($0) {
                case 'd': return date.getDate();
                case 'dd': return zeroize(date.getDate());
                case 'ddd': return ['Sun', 'Mon', 'Tue', 'Wed', 'Thr', 'Fri', 'Sat'][date.getDay()];
                case 'dddd': return ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()];
                case 'M': return date.getMonth() + 1;
                case 'MM': return zeroize(date.getMonth() + 1);
                case 'MMM': return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][date.getMonth()];
                case 'MMMM': return ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][date.getMonth()];
                case 'yy': return new String(date.getFullYear()).substr(2);
                case 'yyyy': return date.getFullYear();
                case 'h': return date.getHours() % 12 || 12;
                case 'hh': return zeroize(date.getHours() % 12 || 12);
                case 'H': return date.getHours();
                case 'HH': return zeroize(date.getHours());
                case 'm': return date.getMinutes();
                case 'mm': return zeroize(date.getMinutes());
                case 's': return date.getSeconds();
                case 'ss': return zeroize(date.getSeconds());
                case 'l': return date.getMilliseconds();
                case 'll': return zeroize(date.getMilliseconds());
                case 'tt': return date.getHours() < 12 ? 'am' : 'pm';
                case 'TT': return date.getHours() < 12 ? 'AM' : 'PM';
            }
        });
    }
    const vscode = acquireVsCodeApi();
    const previousState = vscode.getState();
    const vue = new Vue({
        el: '#app',
        data: {
            result: previousState ? previousState.result : {
                rows: [],
                sql: ''
            },
            updateTime: formatNow('yyyy-MM-dd HH:mm:ss'),
            search: ''
        },
        methods: {
            celledit(row, column, cell, event) {
                cell.contentEditable = true;
                cell.focus()
            },
            execute() {
                vscode.postMessage({
                    type: 'execute',
                    sql: this.result.sql
                });
            },
            save() {
                this.$confirm('Do you want to save change?', 'Warning', {
                    confirmButtonText: 'OK',
                    cancelButtonText: 'Cancel',
                    type: 'Save'
                }).then(() => {
                    this.$message({
                        type: 'success',
                        message: 'Delete completed'
                    });
                })
            },
            deleteConfirm() {
                this.$confirm('Do you want to delete data line?', 'Warning', {
                    confirmButtonText: 'OK',
                    cancelButtonText: 'Cancel',
                    type: 'Save'
                }).then(() => {
                    this.$message({
                        type: 'success',
                        message: 'Delete completed'
                    });
                })
            }
        }
    })

    window.addEventListener('message', event => {
        vue.result.rows = event.data.data
        vue.result.sql = event.data.sql
        vue.updateTime = formatNow('yyyy-MM-dd HH:mm:ss')
        vscode.setState({ result: vue.result });
        document.write(previousState + ":" + count)
    });
</script>

</html>