<html>

<head>
    <title>result</title>
    <link rel="stylesheet" href="css/element.css">
    <script src="js/vue.js"></script>
    <script src="js/element.js"></script>
    <style>
        body {
            background-color: #F7F7F7;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
        }

        .hint {
            padding: 5px;
            font-size: 17px;
            color: #444;
            display: inline-block;
            margin-top: 8px;
        }

        .cell {
            overflow: hidden !important;
            text-overflow: unset !important;
            white-space: nowrap !important;
            user-select: text !important;
            padding: 1px !important;
        }

        .info-panel {
            color: #444;
            font-size: 14px;
            background-color: white;
            border: 1px solid #dcdfe6;
            border-radius: 5px;
            padding: 10px;
            margin-left: 6px;
        }

        /*定义滚动条样式（高宽及背景）*/
        ::-webkit-scrollbar {
            /* 滚动条宽度， width：对应竖滚动条的宽度  height：对应横滚动条的高度*/
            /* width: 6px;   
            background: #007acc; */
        }

        /*定义滚动条轨道（凹槽）样式*/
        ::-webkit-scrollbar-track {
            /* 较少使用 */
            /* -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);   
            border-radius: 3px;  */
        }

        /*定义滑块 样式*/
        ::-webkit-scrollbar-thumb {
            /* 滚动条滑块长度 */
            /* border-radius: 3px; 
            height: 100px;   
            background-color: #ccc;  */
        }

        .el-table .edit-row {
            background: oldlace;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="hint">
            <!-- sql input -->
            <el-row style="margin-bottom: 10px;">
                <el-input type="textarea" autosize v-model="toolbar.sql" style="width: 600px;"></el-input>
            </el-row>
            <!-- tool panel -->
            <el-row>
                <w>
                    <el-input v-model="table.search" style="width:200px" placeholder="Type to search" />
                </w>
                <w>
                    <el-button type="primary" @click='execute(toolbar.sql);info.visible = false;'>Execute</el-button>
                    <span v-if="result.table">
                        {{result.table}}
                    </span>
                </w>
            </el-row>
            <el-row v-if="result.table">
                <el-col>
                    <el-button type="info" icon="el-icon-circle-plus-outline" size="mini" circle @click="insertRequest"
                        v-if="result.primaryKey">
                    </el-button>
                    <span>CostTime: </span><span v-text="toolbar.costTime"></span>ms
                    <span v-if="result.table">, Row: {{result.data.length}}, Col: {{columnCount}}</span>
                </el-col>
            </el-row>
            <!-- info panel -->
            <div v-if="info.visible ">
                <div v-if="info.error" class="info-panel" style="color:red" v-html="info.message"></div>
                <div v-if="!info.error" class="info-panel" style="color: green;" v-html="info.message"></div>
            </div>
        </div>
        <!-- talbe result -->
        <div :style="'width:' + table.width + 'px;overflow:scroll'" v-if="result.data">
            <el-table id="dataTable" v-loading='table.loading' size='small' @sort-change="sort"
                :row-class-name="tableRowClassName" ref="dataTable"
                :data="result.data.filter(data => !table.search || JSON.stringify(data).toLowerCase().includes(table.search.toLowerCase()))"
                border @cell-click="celledit">
                <!-- tool bar -->
                <el-table-column fixed="left" label="Operations" width="100" v-if="result.primaryKey" align="center">
                    <template slot-scope="scope">
                        <div v-if="scope.row.isFilter" style="text-align: center;">
                            <el-popover placement="bottom" title="Select columns to show" width="200" trigger="click">
                                <el-checkbox-group v-model="toolbar.showColumns">
                                    <el-checkbox v-for="(column) in result.columnList" :label="column.name"
                                        :key="column.name">
                                        {{column.name}}
                                    </el-checkbox>
                                </el-checkbox-group>
                                <el-button icon="el-icon-search" circle title="Select columns to show" size="small"
                                    slot="reference"></el-button>
                            </el-popover>
                            <el-button @click="resetFilter" title="Reset filter" type="warning" size="small"
                                icon="el-icon-refresh" circle title="Reset">
                            </el-button>
                        </div>
                        <div v-if="scope.row[result.primaryKey]">
                            <el-button @click="openEdit(scope.row)" type="primary" size="small" icon="el-icon-edit"
                                circle>
                            </el-button>
                            <el-button @click="deleteConfirm(scope.row[result.primaryKey])" type="primary" size="small"
                                icon="el-icon-delete" circle>
                            </el-button>
                        </div>
                    </template>
                </el-table-column>
                <!-- data  -->
                <el-table-column :label="field.name" v-for="field in result.fields" :key="field.name" align="center"
                    sortable v-if="result.columnList && toolbar.showColumns.includes(field.name.toLowerCase())"
                    :width="computeWidth(field.name,0,toolbar.filter[field.name])">
                    <template slot-scope="scope">
                        <el-input v-if="scope.row.isFilter" v-model="toolbar.filter[field.name]" placeholder="filter"
                            @blur="filter($event,field.name)" v-on:keyup.enter.native="filter($event,field.name)">
                        </el-input>
                        <span v-if="!scope.row.isFilter" v-html='dataformat(scope.row[field.name])'></span>
                    </template>
                </el-table-column>
            </el-table>
        </div>
        <el-dialog :title="editorTilte" :visible.sync="editor.visible" width="90%" top="3vh" size="small">
            <el-form ref="infoForm" :model="update.currentNew">
                <el-form-item :prop="column.name" :key="column.name" v-for="column in result.columnList" size="mini">
                    <template>
                        <span>
                            {{column.name}} : {{column.type}} : <span
                                style="color: red;">{{column.key}}{{column.nullable=='YES'?'':' Required'}}</span>&nbsp;
                            {{column.comment?column.comment:''}}
                        </span>
                        <el-input v-model="update.currentNew[column.name]"></el-input>
                    </template>
                </el-form-item>
            </el-form>
            <span slot="footer" class="dialog-footer">
                <el-button @click="editor.visible = false">Cancel</el-button>
                <el-button v-if="update.primary!=null" type="primary" :loading="editor.loading" @click="confirmUpdate">
                    Update</el-button>
                <el-button v-if="update.primary==null" type="primary" :loading="editor.loading" @click="confirmInsert">
                    Insert</el-button>
            </span>
        </el-dialog>
    </div>
</body>

<script>
    const vscode = acquireVsCodeApi();
    // const previousState = vscode.getState();
    const previousState = false;
    const vue = new Vue({
        el: '#app',
        data: {
            result: {
                data: [],
                sql: '',
                primaryKey: null,
                columnList: null,
                database: null,
                table: null
            },
            table: {
                search: '',
                loading: true,
                width: null,
                widthItem: {}
            },
            toolbar: {
                sql: null,
                costTime: 0,
                isRefrsh: false,
                filter: {},
                showColumns: []
            },
            editor: {
                visible: false,
                loading: false
            },
            info: {
                sql: null,
                message: null,
                visible: false,
                error: false,
                // rule have bug, disable it.
                // rule: {}
            },
            update: {
                current: {},
                currentNew: {},
                primary: null
            }
        },
        methods: {
            filter(event, column) {

                let inputvalue = "" + event.target.value

                let filterSql = this.result.sql.replace(/\n/, " ").replace(";", " ") + " "

                let existsCheck = new RegExp(`(WHERE|AND)?\\s*${column}\\s*=\\s*.+?\\s`, 'igm');

                if (inputvalue) {
                    inputValue = "" + inputvalue
                    if (existsCheck.exec(filterSql)) {
                        // condition present
                        filterSql = filterSql.replace(existsCheck, `$1 ${column}='${inputValue}' `)
                    } else if (filterSql.match(/\bwhere\b/ig) && inputvalue) {
                        //have where
                        filterSql = filterSql.replace(/\b(where)\b/ig, `\$1 ${column}='${inputvalue}' AND `)
                    } else if (inputvalue) {
                        //have not where
                        filterSql = filterSql.replace(new RegExp(`(from\\s*.+?)\\s`, 'ig'), `\$1 WHERE ${column}='${inputvalue}' `)
                    }
                } else {
                    // empty value, clear filter
                    let beforeAndCheck = new RegExp(`${column}\\s*=\\s*.+?\\s*AND`, 'igm');
                    if (beforeAndCheck.exec(filterSql)) {
                        filterSql = filterSql.replace(beforeAndCheck, "")
                    } else {
                        filterSql = filterSql.replace(existsCheck, " ")
                    }
                }

                this.execute(filterSql + ";")
            },
            resetFilter() {
                this.execute(
                    this.result.sql.replace(/where.+?\b(order|limit|group)\b/ig, "$1")
                )
            },
            sort(row) {
                let order = row.order == 'ascending' ? "asc" : "desc"
                let sortSql = this.result.sql
                    .replace(/\n/, " ").replace(";", "")
                    .replace(/order by .+? (desc|asc)?/ig, "")
                    .replace(/\s?(limit.+)?$/i, ` ORDER BY ${row.column.label} ${order} \$1 `)
                this.execute(sortSql + ";")
            },
            insertRequest() {
                this.editor.visible = true;
                this.update.primary = null;
                this.update.currentNew = {};
                // this.$refs['infoForm'].resetFields();
            },
            confirmInsert() {
                let columns = "";
                let values = "";
                for (const key in this.update.currentNew) {
                    const newEle = this.update.currentNew[key];
                    if (newEle) {
                        columns += `${key},`;
                        values += `'${newEle.replace(/'/g, "\\'")}',`;
                    }
                }
                if (values) {
                    const insertSql = `INSERT INTO ${this.result.table}(${columns.replace(/,$/, "")}) VALUES(${values.replace(/,$/, "")})`
                    this.execute(insertSql)
                } else {
                    this.$message("Not any input, update fail!")
                }
            },
            confirmUpdate() {
                let change = "";
                for (const key in this.update.currentNew) {
                    const oldEle = this.update.current[key];
                    const newEle = this.update.currentNew[key];
                    if (oldEle != newEle) {
                        change += `${key}='${newEle.replace(/'/g, "\\'")}',`
                    }
                }
                if (change) {
                    const updateSql = `UPDATE ${this.result.table} SET ${change.replace(/,$/, "")} WHERE ${this.result.primaryKey}=${this.update.primary}`
                    this.execute(updateSql)
                } else {
                    this.$message("Not any change, update fail!")
                }
            },
            openEdit(row) {
                this.$nextTick(() => {
                    //获取不到, 貌似要从mounted的时候获取
                    // this.$refs['infoForm'].resetFields();
                })
                this.editor.visible = true;
                this.update = {
                    current: row,
                    currentNew: this.deepClone(row),
                    primary: row[this.result.primaryKey]
                }
            },
            uploadRole() {
                if (this.result.columnList == null) return;
                let rule = {};
                for (let column of this.result.columnList) {
                    rule[column.name] = {
                        required: (column.nullable == "NO") && (column.key != "PRI"),
                        max: column.maxLength
                    }
                }
                this.info.rule = rule
            },
            deleteConfirm(primaryValue) {
                this.$confirm('Are you sure you want to delete this data?', 'Warning', {
                    confirmButtonText: 'OK',
                    cancelButtonText: 'Cancel',
                    type: 'warning'
                }).then(() => {
                    const deleteSql = `DELETE FROM ${this.result.table} WHERE ${this.result.primaryKey}='${primaryValue}'`;
                    this.execute(deleteSql)
                }).catch(() => {
                    this.$message({ type: 'info', message: 'Update canceled' });
                });
            },
            tableRowClassName({ row, rowIndex }) {
                if (!this.result.primaryKey || !this.update.primary) return ''
                if (row[this.result.primaryKey] == this.update.primary) {
                    return 'edit-row';
                }
                return '';
            },
            updateWidth() {
                let width = 0;
                for (const key in this.table.widthItem) {
                    width = width + parseInt(this.table.widthItem[key])
                }
                if (this.result.primaryKey) {
                    width += 60;
                }
                this.table.width = width + 60;

            },
            computeWidth(key, index, value) {
                if (this.table.widthItem[key]) return this.table.widthItem[key];
                if (!index) index = 0
                if (!this.result.data[index] || index > 10) return 60;
                if (!value) {
                    value = this.result.data[index][key];
                }
                var dynamic = value ? ((value + "").length) * 10 : ((key + "").length) * 10;
                if (dynamic > 600) dynamic = 600;
                if (dynamic < 60) dynamic = 60;
                var nextDynamic = this.computeWidth(key, ++index)
                if (dynamic < nextDynamic) dynamic = nextDynamic;
                this.table.widthItem[key] = dynamic;
                this.updateWidth()
                return dynamic;
            },
            celledit(row, column, cell, event) {
                if (row.isFilter) {
                    return;
                }
                cell.contentEditable = true;
                if (this.result.primaryKey) {
                    this.update.primary = row[this.result.primaryKey]
                }
            },
            refresh() {
                if (this.result.sql) {
                    this.toolbar.isRefrsh = true;
                    this.execute(this.result.sql)
                }
            },
            execute(sql) {
                if (!sql) return;
                vscode.postMessage({
                    type: 'execute',
                    sql: sql.replace(/ +/ig, " ")
                });
                this.table.loading = true;
            },
            deleteTemplate() {
                this.result.sql = `DELETE FROM [table] WHERE id= `;
            },
            dataformat(origin) {
                if (origin == undefined || origin == null) {
                    return "<b>(NULL)</b>";
                }
                return origin;
            },
            deepClone(obj) {
                let objClone = Array.isArray(obj) ? [] : {};
                if (obj && typeof obj === "object") {
                    for (let key in obj) {
                        if (obj.hasOwnProperty(key)) {
                            if (obj[key] && typeof obj[key] === "object") {
                                objClone[key] = this.deepClone(obj[key]);
                            } else {
                                objClone[key] = obj[key];
                            }
                        }
                    }
                }
                return objClone;
            }, initShowColumn(columnList) {
                this.toolbar.showColumns = []
                for (let i = 0; i < columnList.length; i++) {
                    this.toolbar.showColumns.push(columnList[i].name.toLowerCase());
                }
            }

        },
        computed: {
            columnCount() {
                if (this.result.data == undefined || this.result.data[0] == undefined) return 0;
                return Object.keys(this.result.data[0]).length;
            },
            editorTilte() {
                if (this.update.primary == null) {
                    return 'Insert To ' + this.result.table
                }
                return 'Edit For ' + this.result.table + ' : ' + this.result.primaryKey + '=' + this.update.primary
            },
        }
    })

    const handlerData = (data) => {

        vue.result.sql = data.sql;
        vue.toolbar.sql = data.sql;
        vue.table.widthItem = {}
        vue.result = data;
        vue.table.loading = false
        if (!data.sql.match(/\bwhere\b/ig)) {
            // clear filter
            vue.toolbar.filter = {}
            vue.$refs.dataTable.clearSort()
        }
        if (vue.result.columnList) {
            vue.uploadRole()
            // add filter row
            vue.result.data.unshift({ isFilter: true, content: '' })
            vue.initShowColumn(vue.result.columnList)
        }
        if (vue.toolbar.isRefrsh) {
            vue.toolbar.isRefrsh = false;
        } else {
            vue.info.visible = false;
        }
        // vscode.setState({ result: vue.result }); is instead by retainContextWhenHidden=true
    }

    const handlerCommon = (res) => {
        vue.editor.loading = false;
        vue.editor.visible = false;
        vue.info.visible = true;
        vue.info.message = res.message
        // vue.$message({ type: 'success', message: `EXECUTE ${res.sql} SUCCESS, affectedRows:${res.affectedRows}` });
    }

    window.addEventListener('message', event => {
        vue.table.loading = false;
        let response = event.data.res;
        if (response.costTime) {
            vue.toolbar.costTime = response.costTime
        }
        switch (event.data.type) {
            case "RUN":
                vue.toolbar.sql = response.sql;
                vue.table.loading = true;
                break;
            case "DATA":
                handlerData(response)
                break;
            case "DML":
            case "DDL":
                handlerCommon(response)
                vue.info.error = false
                vue.refresh()
                break;
            case "ERROR":
                handlerCommon(response)
                vue.info.error = true
                break;
            case "MESSAGE":
                if(response.success){
                    vue.$message.success(response.message)
                }else{
                    vue.$message.error(response.message)
                }
                break;
            default:
                vue.$message(JSON.stringify(event.data));
        }
    });
    vscode.postMessage({ type: 'init' })
    setInterval(() => {
        // vue.updateWidth()
    }, 100)
</script>

</html>